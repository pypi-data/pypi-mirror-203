include: 
  - https://gitlab.com/Linaro/tuxpkg/-/raw/main/gitlab-ci-pipeline.yml

variables:
  TUXPKG_PROJECT: tuxtrigger
  TUXSUITE_TOKEN: $TUXSUITE_TOKEN

.job:
  script:
  - make $CI_JOB_NAME

stylecheck:
  extends: .job
  stage: test

typecheck: 
  extends: .job
  stage: test

spellcheck:
  extends: .job
  stage: test

image-build:
  stage: build
  image: docker:20.10.16
  services:
    - name: docker:20.10.16-dind
  variables:
    DOCKER_DRIVER: overlay2
    DOCKER_HOST: tcp://docker:2375
    DOCKER_TLS_CERTDIR: ""
  script:
  - 'docker build -t $CI_REGISTRY_IMAGE/tuxtrigger -f Dockerfile .'
  - 'docker login -u $CI_REGISTRY_USER -p $CI_REGISTRY_PASSWORD $CI_REGISTRY'
  - 'docker push $CI_REGISTRY_IMAGE/tuxtrigger'
  only:
    refs:
    - main

doc:
  extends: .job
  stage: build
  artifacts:
    paths:
      - public
  before_script:
    - python3 -m pip install mkdocs-material
  
pages:
  extends: .job
  stage: deploy
  needs:
    - doc
    - repository
  artifacts:
    paths:
      - public
  only:
    - tags
  script:
    - cp -r dist/repo public/packages/
